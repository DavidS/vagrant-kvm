#!/bin/bash

set -e

TMP_DIR="$1.tmp"
INPUT=$1
OUTPUT=$2

mkdir $TMP_DIR

bsdtar -v -x -m -C $TMP_DIR -f $INPUT
qemu-img convert -c -S 16k -f vmdk -O qcow2 $TMP_DIR/box-disk1.vmdk $TMP_DIR/box-disk1.img
echo '{"provider": "kvm"}' >> $TMP_DIR/metadata.json
tar -C $TMP_DIR -cvSzf $OUTPUT $(ls $TMP_DIR)

